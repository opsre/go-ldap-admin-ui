main:
  push:
    - runner:
        cpus: 16
      services:
        - docker
        - git-clone-yyds
      stages:
        - name: æ„å»ºç¼“å­˜é•œåƒ
          type: docker:cache
          options:
            dockerfile: .cache.dockerfile
            by:
              - package.json
              - package-lock.json
            versionBy:
              - package.json
          exports:
            name: DOCKER_CACHE_IMAGE_NAME
        - name: ç›´æ¥ä½¿ç”¨ç¼“å­˜é•œåƒç¯å¢ƒå®‰è£…ä¾èµ–å¹¶ç¼–è¯‘
          image: $DOCKER_CACHE_IMAGE_NAME
          script: |
            ln -snf $NODE_PATH node_modules
            time npm install
            sed -i 's@http://localhost:8888/@/@g' .env.production
            time yarn build:prod
        - name: ğŸ‹ æ¨é€é•œåƒ
          script: |
            docker run -d --name buildkitd \
              --security-opt seccomp=unconfined \
              --security-opt apparmor=unconfined \
              --security-opt systempaths=unconfined \
              moby/buildkit:rootless
            docker buildx create --use \
              --name mybuilder \
              --driver remote docker-container://buildkitd
            docker buildx build \
              -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE} \
              --platform=linux/arm64,linux/amd64 . --push